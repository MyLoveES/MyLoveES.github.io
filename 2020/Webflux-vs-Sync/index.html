<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Webflux 号称性能强悍，实际项目里却发现性能不升反降。经验上，当后端服务的响应时间小于10ms，则异步非阻塞提升不明显，甚至效果变差。本文会将对此做验证。"><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><title>低延时场景不要用 Webflux | 三点水</title><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><meta name="generator" content="Hexo 4.2.1"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/books">Books</a><a class="sidebar-nav-item" href="/about">About</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-link" href="/tags/benchmark/" rel="tag">benchmark</a><a class="post-tag-link" href="/tags/java/" rel="tag">java</a><a class="post-tag-link" href="/tags/reactor/" rel="tag">reactor</a><a class="post-tag-link" href="/tags/webflux/" rel="tag">webflux</a></div><div class="post-time">2020-04-12</div></div></div><div class="container post-header"><h1>低延时场景不要用 Webflux</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">Table of Contents</summary><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#实验设置"><span class="toc-number">1.</span> <span class="toc-text">实验设置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#实验结果"><span class="toc-number">2.</span> <span class="toc-text">实验结果</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#测试代码"><span class="toc-number">3.</span> <span class="toc-text">测试代码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#详细实验设置"><span class="toc-number">4.</span> <span class="toc-text">详细实验设置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#小结"><span class="toc-number">5.</span> <span class="toc-text">小结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考"><span class="toc-number">6.</span> <span class="toc-text">参考</span></a></li></ol></details></div><div class="container post-content"><p>Webflux 号称性能强悍，实际项目里却发现性能不升反降。经验上，当后端服务的响应时间小于10ms，则异步非阻塞提升不明显，甚至效果变差。本文会将对此做验证。</p>
<p>（注：性能相关的结论只能作为经验结论，实际程序的表现还是需要实际 profile）</p>
<h2 id="实验设置"><a class="header-anchor" href="#实验设置"></a>实验设置</h2>
<p>数据流如下：通过 jmeter 发送 POST 请求到 TestService，转发流量到后端服务。</p>
<img src="/2020/Webflux-vs-Sync/Experiment-Setup.svg" class="" title="Experiment Setup">
<p>这里发送的请求是 POST 请求，发送内容是约为 800B 的 Json 来保证一定程度上的计算量，目的是为了模拟真实的使用场景。事实上如果只是转发 GET 而没有任何计算，则
webflux 完胜 blocking 的方式。</p>
<h2 id="实验结果"><a class="header-anchor" href="#实验结果"></a>实验结果</h2>
<p>结论：在 Backend 低延时(&lt;10ms)的情况下，Webflux 的的彼时和吞吐都普遍不如
blocking 的方式。</p>
<img src="/2020/Webflux-vs-Sync/Webflux-vs-Sync.svg" class="" title="Experiment Result">
<p>上图中，左图代表延时，右图代表吞吐，横坐标是后端 sleep 的毫秒数。横坐标是 log
坐标，用以保证 &lt;10ms 的密集区可以较好地展示。延时只关心 99 分位和 999 分位（图中同颜色的线，下方代表 99 分位，上方代表 999 分位），不用关心绝对值，只需要关注蓝线和红线的相对位置。解读如下：</p>
<ul>
<li>左边 4 图中，当后端 sleep &lt; 10ms 时，99 分位的蓝线都要低于红线，代表同步延时要低于 webflux</li>
<li>sleep &lt; 10ms 时，999 分位的蓝线普遍低于红线，但也有例外</li>
<li>右边 4 图的吞吐，在 sleep &lt; 10ms 时蓝线均低于红线。代表同步的吞吐更高</li>
<li>灰线代表的直接发送的方式不同情况下延时和吞吐都有波动，目前还没想明白原因</li>
<li>当压力和后端延时增加时，webflux 的优势也慢慢体现</li>
</ul>
<p>详细实验结果参见：<a href="https://docs.google.com/spreadsheets/d/1BDWcwZhEx2SczAXUteRQhYk5DIpwv3m6E5P6EU3vNp4/edit?usp=sharing" target="_blank" rel="noopener">Webflux vs Sync</a>。</p>
<h2 id="测试代码"><a class="header-anchor" href="#测试代码"></a>测试代码</h2>
<p>Backend 代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span>(<span class="string">"/post/&#123;ms&#125;/&#123;numItems&#125;"</span>)</span><br><span class="line"><span class="keyword">public</span> Mono&lt;Map&lt;String, Object&gt;&gt; postAsync(<span class="meta">@PathVariable</span> <span class="keyword">long</span> ms, <span class="meta">@PathVariable</span> <span class="keyword">int</span> numItems, <span class="meta">@RequestBody</span> Map&lt;String, Object&gt; request) &#123;</span><br><span class="line">    Map&lt;String, Object&gt; response = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// consume request</span></span><br><span class="line">    <span class="keyword">long</span> requestLength = request.entrySet().stream()</span><br><span class="line">            .map(Object::toString)</span><br><span class="line">            .mapToInt(String::length)</span><br><span class="line">            .sum();</span><br><span class="line">    response.put(<span class="string">"total"</span>, requestLength);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// insert random items</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;numItems; i++) &#123;</span><br><span class="line">        response.put(<span class="string">"random_"</span> + i, UUID.randomUUID().toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// sleep</span></span><br><span class="line">    <span class="keyword">if</span> (ms &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> Mono.delay(Duration.ofMillis(ms)).map(it -&gt; response);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Mono.just(response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>同步代码如下，注意 http client 的最大连接数设置为 300，tomcat 线程数默认为
200。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span>(<span class="string">"/post/&#123;ms&#125;/&#123;numItems&#125;"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">post</span><span class="params">(@PathVariable <span class="keyword">long</span> ms, @PathVariable <span class="keyword">int</span> numItems, @RequestBody Map&lt;String, Object&gt; request)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String url = String.format(<span class="string">"http://%s/post/%d/%d"</span>, baseUrl, ms, numItems);</span><br><span class="line">    StringEntity entity = <span class="keyword">new</span> StringEntity(objectMapper.writeValueAsString(request), ContentType.APPLICATION_JSON);</span><br><span class="line">    HttpPost httpPost = <span class="keyword">new</span> HttpPost(url);</span><br><span class="line">    httpPost.setEntity(entity);</span><br><span class="line">    HttpEntity responseEntity = httpClient.execute(httpPost).getEntity();</span><br><span class="line">    <span class="keyword">return</span> EntityUtils.toString(responseEntity);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Webflux 异步发送代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span>(<span class="string">"/post/&#123;ms&#125;/&#123;numItems&#125;"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Mono&lt;String&gt; <span class="title">post</span><span class="params">(@PathVariable <span class="keyword">long</span> ms, @PathVariable <span class="keyword">int</span> numItems, @RequestBody Map&lt;String, Object&gt; request)</span> </span>&#123;</span><br><span class="line">    String url = String.format(<span class="string">"http://%s/post/%d/%d"</span>, baseUrl, ms, numItems);</span><br><span class="line">    <span class="keyword">return</span> webClient.post()</span><br><span class="line">            .uri(url)</span><br><span class="line">            .body(BodyInserters.fromValue(request))</span><br><span class="line">            .retrieve()</span><br><span class="line">            .bodyToMono(String<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>发送的 Json 为：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"random1"</span>: <span class="number">1</span>, <span class="attr">"random2"</span>: <span class="number">2</span>, <span class="attr">"random3"</span>: <span class="number">3</span>, <span class="attr">"random4"</span>: <span class="number">4</span>, <span class="attr">"random5"</span>: <span class="number">5</span>,</span><br><span class="line">    <span class="attr">"random6"</span>: <span class="number">6</span>, <span class="attr">"random7"</span>: <span class="number">7</span>, <span class="attr">"random8"</span>: <span class="number">8</span>, <span class="attr">"random9"</span>: <span class="number">9</span>, <span class="attr">"random10"</span>: <span class="number">10</span>,</span><br><span class="line">    <span class="attr">"random11"</span>: <span class="number">11</span>, <span class="attr">"random12"</span>: <span class="number">12</span>, <span class="attr">"random13"</span>: <span class="number">13</span>, <span class="attr">"random14"</span>: <span class="number">14</span>, <span class="attr">"random15"</span>: <span class="number">15</span>,</span><br><span class="line">    <span class="attr">"random16"</span>: <span class="number">16</span>, <span class="attr">"random17"</span>: <span class="number">17</span>, <span class="attr">"random18"</span>: <span class="number">18</span>, <span class="attr">"random19"</span>: <span class="number">19</span>, <span class="attr">"random20"</span>: <span class="number">20</span>,</span><br><span class="line">    <span class="attr">"random21"</span>: <span class="number">21</span>, <span class="attr">"random22"</span>: <span class="number">22</span>, <span class="attr">"random23"</span>: <span class="number">23</span>, <span class="attr">"random24"</span>: <span class="number">24</span>, <span class="attr">"random25"</span>: <span class="number">25</span>,</span><br><span class="line">    <span class="attr">"random26"</span>: <span class="number">26</span>, <span class="attr">"random27"</span>: <span class="number">27</span>, <span class="attr">"random28"</span>: <span class="number">28</span>, <span class="attr">"random29"</span>: <span class="number">29</span>, <span class="attr">"random30"</span>: <span class="number">30</span>,</span><br><span class="line">    <span class="attr">"random31"</span>: <span class="number">31</span>, <span class="attr">"random32"</span>: <span class="number">32</span>, <span class="attr">"random33"</span>: <span class="number">33</span>, <span class="attr">"random34"</span>: <span class="number">34</span>, <span class="attr">"random35"</span>: <span class="number">35</span>,</span><br><span class="line">    <span class="attr">"random36"</span>: <span class="number">36</span>, <span class="attr">"random37"</span>: <span class="number">37</span>, <span class="attr">"random38"</span>: <span class="number">38</span>, <span class="attr">"random39"</span>: <span class="number">39</span>, <span class="attr">"random40"</span>: <span class="number">40</span>,</span><br><span class="line">    <span class="attr">"random41"</span>: <span class="number">41</span>, <span class="attr">"random42"</span>: <span class="number">42</span>, <span class="attr">"random43"</span>: <span class="number">43</span>, <span class="attr">"random44"</span>: <span class="number">44</span>, <span class="attr">"random45"</span>: <span class="number">45</span>,</span><br><span class="line">    <span class="attr">"random46"</span>: <span class="number">46</span>, <span class="attr">"random47"</span>: <span class="number">47</span>, <span class="attr">"random48"</span>: <span class="number">48</span>, <span class="attr">"random49"</span>: <span class="number">49</span>, <span class="attr">"random50"</span>: <span class="number">50</span>,</span><br><span class="line">    <span class="attr">"random51"</span>: <span class="number">51</span>, <span class="attr">"random52"</span>: <span class="number">52</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="详细实验设置"><a class="header-anchor" href="#详细实验设置"></a>详细实验设置</h2>
<ul>
<li>分别对 sleep 1-10, 20, 30, 40, 50ms 的 Backend 进行压测，numItems 均为 1</li>
<li>压测使用 Jmeter（尝试过 wrk，结果不准确）</li>
<li>分别用 50, 100, 200, 300 线程发送请求</li>
<li>每次实验压测 1 分钟。</li>
<li>JVM 参数中 <code>Xmx</code> 和 <code>Xms</code> 均设置为 4G</li>
<li>Jmeter 到 TestService 使用长连接，TestService 到 Backend 使用库的默认选项（应该都是短连接）。</li>
</ul>
<h2 id="小结"><a class="header-anchor" href="#小结"></a>小结</h2>
<p>要再次强调的是：实验不代表真实使用场景。本实验也只是尝试模拟博主自己的使用场景，而且是事后验证，先是生产遇到不升反降，再反过来验证。</p>
<p>结论：在 IO 延时小的情况下，webflux 的性能不如同步阻塞的方法</p>
<p>从原理来说，webflux 所代表的异步非阻塞的主要作用是使用少量的线程资源处理大量的
IO ，也就是<strong>提高吞吐</strong>，但是提交任务和 worker thread 抢占任务执行等等都有开销，而这部分开销和同步阻塞的线程创建和切换的开销相比，究竟谁优谁劣，就需要在程序中实际验证了。</p>
<p>不过从技术选型的角度，文章得出的结论是，webflux 不适用于低延时的场景。</p>
<h2 id="参考"><a class="header-anchor" href="#参考"></a>参考</h2>
<p>Webflux 文档中关于性能的描述：</p>
<blockquote>
<p>Performance has many characteristics and meanings. Reactive and non-blocking
generally do not make applications run faster. They can, in some cases, (for
example, if using the WebClient to execute remote calls in parallel). On the
whole, it requires more work to do things the non-blocking way and that can
increase slightly the required processing time.</p>
<p><a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/web-reactive.html#webflux-performance" target="_blank" rel="noopener">https://docs.spring.io/spring/docs/current/spring-framework-reference/web-reactive.html#webflux-performance</a></p>
</blockquote>
<ul>
<li><a href="https://medium.com/@filia.aleks/microservice-performance-battle-spring-mvc-vs-webflux-80d39fd81bf0" target="_blank" rel="noopener">Spring Boot performance battle: blocking vs non-blocking vs reactive</a> 对后端高延时的情况进行测试，结论是 webflux 均好于其它情况</li>
<li><a href="https://medium.com/@the.raj.saxena/springboot-2-performance-servlet-stack-vs-webflux-reactive-stack-528ad5e9dadc" target="_blank" rel="noopener">SpringBoot 2 performance — servlet stack vs WebFlux reactive stack</a> Webflux 不几乎不损失性能下能极大提高吞吐</li>
</ul></div></div><div class="post-main post-comment"><div id="disqus_thread"></div><script type="text/javascript">
var disqus_shortname = 'lotaboutlife';
var disqus_identifier = '2020/Webflux-vs-Sync/';
var disqus_title = '低延时场景不要用 Webflux';
var disqus_url = 'https://lotabout.me/2020/Webflux-vs-Sync/';
(function() {
   var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
   dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
   (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript" target="_blank" rel="noopener">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" target="_blank" rel="noopener" class="dsq-brlink">Blog comments powered by <span class="logo-disqus">Disqus</span></a></div></article><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
e=o.createElement(i);r=o.getElementsByTagName(i)[0];
e.src='//www.google-analytics.com/analytics.js';
r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
ga('create','UA-39956831-2');ga('send','pageview');</script></body></html>