<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="最近遇到磁盘占用 100% 的问题，发现 &lt;code&gt;/tmp&lt;/code&gt; 目录下多出许多类似
&lt;code&gt;my-app.jar-spring-boo-libs-xxx&lt;/code&gt; 的目录。这些目录是什么，如何避免磁盘爆了？"><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><title>QQA: /tmp 目录下的 spring-boot-libs 是什么 | 三点水</title><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><meta name="generator" content="Hexo 4.2.1"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/books">Books</a><a class="sidebar-nav-item" href="/about">About</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-link" href="/tags/QQA/" rel="tag">QQA</a><a class="post-tag-link" href="/tags/Spring/" rel="tag">Spring</a></div><div class="post-time">2019-09-23</div></div></div><div class="container post-header"><h1>QQA: /tmp 目录下的 spring-boot-libs 是什么</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">Table of Contents</summary><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#这些目录是什么？"><span class="toc-number">1.</span> <span class="toc-text">这些目录是什么？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#磁盘会爆吗？"><span class="toc-number">2.</span> <span class="toc-text">磁盘会爆吗？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#如何避免磁盘爆了？"><span class="toc-number">3.</span> <span class="toc-text">如何避免磁盘爆了？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考"><span class="toc-number">4.</span> <span class="toc-text">参考</span></a></li></ol></details></div><div class="container post-content"><p>最近遇到磁盘占用 100% 的问题，发现 <code>/tmp</code> 目录下多出许多类似
<code>my-app.jar-spring-boo-libs-xxx</code> 的目录。这些目录是什么，如何避免磁盘爆了？</p>
<h2 id="这些目录是什么？"><a class="header-anchor" href="#这些目录是什么？"></a>这些目录是什么？</h2>
<p>Spring boot 会将依赖的 jar 包最终打成一个大的 jar 包（称为 fat jar），同时使用
spring boot 自己的 class loader 来加载这些 jar 包。对于使用者来说是相当便利的。</p>
<p>然而有些 jar 包不能用这种方式加载，jruby-complete.jar 是其中一个例子。而这次我遇到的则是 jython-standalone.jar。于是 Spring Boot 提供了一种方式，让用户指定在运行时，将一些 jar 包解压，用常规的加载方式加载。在 pom 中通过
<a href="https://docs.spring.io/spring-boot/docs/current/reference/htmlsingle/#howto-extract-specific-libraries-when-an-executable-jar-runs" target="_blank" rel="noopener">requiresUnpack</a>
指定：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">requiresUnpack</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.python<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jython-standalone<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">requiresUnpack</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>在运行时，Spring boot 会将指定的 jar 包解压到 <code>java.io.tmpdir</code> 指定的目录中，默认为 <code>/tmp</code>。也就是我们在引言中提到的问题。</p>
<h2 id="磁盘会爆吗？"><a class="header-anchor" href="#磁盘会爆吗？"></a>磁盘会爆吗？</h2>
<p>其实问题是 <code>/tmp</code> 目录会被操作系统自动清理吗？不同操作系统的行为不同。这里以
CentOS 7 为例。</p>
<ul>
<li>CentOS 7 会将 <code>/tmp</code> 挂载为 <code>tmpfs</code>，这样在系统重启时整个 <code>/tmp</code> 都将被清理。</li>
<li>CentOS 7 使用 <code>systemd-tmpfiles</code> 来清理临时文件，默认清理 <code>/tmp</code> 超过 10 天未被访问的文件。</li>
</ul>
<p>所以正常情况下其实不用担心磁盘爆了。博主遇到的情况，是程序由于数据库的问题启动失败，同时又有一个守护进程，检测到进程退出后不断重启，导致在短时间内创建了极大量的目录，从而硬盘占用达到 100%。</p>
<h2 id="如何避免磁盘爆了？"><a class="header-anchor" href="#如何避免磁盘爆了？"></a>如何避免磁盘爆了？</h2>
<p>最好的方式是在启动程序时使用一个本地目录，在每次重启时清理该目录。</p>
<ul>
<li>判断如果存在临时目录则删除</li>
<li>程序启动时通过 <code>-Djava.io.tmpdir</code> 来指定具体的临时目录</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">DIR=$(<span class="built_in">cd</span> `dirname <span class="variable">$0</span>`; <span class="built_in">pwd</span>)</span><br><span class="line">TMP_DIR=<span class="variable">$DIR</span>/tmp</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -d <span class="variable">$TMP_DIR</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"cleaning temporary folder"</span></span><br><span class="line">    rm -rf <span class="variable">$TMP_DIR</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">nohup java -Djava.io.tmpdir=<span class="variable">$TMP_DIR</span> -jar my-app.jar &gt;/dev/null 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure>
<p>顺带一提，事实上目前无法单独设置 unpack 的目录，<code>java.io.tmpdir</code> 其实会影响所有临时文件。例如 tomcat 会在其中创建 <code>tomcat.xxxx</code> 目录，用来存放上传的临时文件。</p>
<h2 id="参考"><a class="header-anchor" href="#参考"></a>参考</h2>
<ul>
<li><a href="https://docs.spring.io/spring-boot/docs/current/reference/htmlsingle/#howto-extract-specific-libraries-when-an-executable-jar-runs" target="_blank" rel="noopener">Spring Boot Reference Guide</a> Spring Boot 官方文档对 requiresUnpack 功能的说明</li>
<li><a href="https://stackoverflow.com/a/53323151" target="_blank" rel="noopener">Spring Boot Maven Plugin and requiresUnpack target
directory</a> 如何修改 requiresUnpack
目录</li>
<li><a href="https://stackoverflow.com/questions/38900375/spring-boot-requiresunpack-is-not-upacking-at-runtime" target="_blank" rel="noopener">Spring Boot requiresUnpack is not upacking at runtime</a> requiresUnpack 解压目录实例</li>
<li><a href="https://centosfaq.org/centos/centos-7-tmpwatch/" target="_blank" rel="noopener">CentOS 7 Tmpwatch</a> 解释
CentOS 7 为什么不包含 tmpwatch</li>
<li><a href="https://www.thegeekdiary.com/centos-rhel-7-how-tmpfiles-clean-up-tmp-or-var-tmp-replacement-of-tmpwatch/" target="_blank" rel="noopener">How systemd-tmpfiles cleans up /tmp/ or /var/tmp (replacement of tmpwatch) in CentOS / RHEL 7</a></li>
<li><a href="https://blog.51cto.com/kusorz/2051877" target="_blank" rel="noopener">CentOS7的/tmp目录自动清理规则</a></li>
</ul></div></div><div class="post-main post-comment"><div id="disqus_thread"></div><script type="text/javascript">
var disqus_shortname = 'lotaboutlife';
var disqus_identifier = '2019/QQA-where-do-spring-boot-s-unpacked-jars-goes/';
var disqus_title = 'QQA: /tmp 目录下的 spring-boot-libs 是什么';
var disqus_url = 'https://lotabout.me/2019/QQA-where-do-spring-boot-s-unpacked-jars-goes/';
(function() {
   var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
   dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
   (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript" target="_blank" rel="noopener">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" target="_blank" rel="noopener" class="dsq-brlink">Blog comments powered by <span class="logo-disqus">Disqus</span></a></div></article><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
e=o.createElement(i);r=o.getElementsByTagName(i)[0];
e.src='//www.google-analytics.com/analytics.js';
r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
ga('create','UA-39956831-2');ga('send','pageview');</script></body></html>